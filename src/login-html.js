module.exports = `
<!DOCTYPE html> <html lang="zh"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Tinger 第三方登录</title> <style> * { margin: 0; padding: 0; box-sizing: border-box; } body { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; } #alert { --back-color: #d1e7dd; --color: #0f5132; --border: #badbcc; width: 100vw; height: 50px; display: flex; align-items: center; padding: 10px 30px; position: fixed; top: -50px; left: 0; transition: top 200ms; background-color: var(--back-color); color: var(--color); border: 1px solid var(--border); } #alert.show { top: 0; } #alert.error { --back-color: #f8d7da; --color: #842029; --border: #f5c2c7; } .alert-title { width: 4em; line-height: 30px; text-align: center; background-color: #cfe2ff; color: #084298; border: 1px solid #b6d4fe; } .alert-msg { line-height: 30px; margin: 0 auto 0 10px; } .alert-close { width: 1em; height: 1em; fill: var(--color); cursor: pointer; } .container { width: 420px; display: flex; flex-direction: column; align-items: center; padding: 20px 15px; box-shadow: 4px 4px 10px lightgray; } .wx-follow { width: 120px; height: 120px; } .tip1 { color: rgb(206, 29, 29); font-size: 0.9em; } .choices { width: 100%; display: flex; align-items: center; border-bottom: 1px solid lightgray; margin: 30px 0 20px; } .choices>div { width: 50%; text-align: center; line-height: 28px; user-select: none; cursor: pointer; } .choices>div.active { background-color: skyblue; } #scan-content { display: flex; flex-direction: column; align-items: center; } #scan-qrcode { margin-top: 10px; width: 160px; height: 160px; } .tip2 { color: gray; font-size: 0.9em; } #code-content { width: 100%; display: none; flex-direction: column; align-items: center; } .code-box { width: 75%; margin: 30px 0 98px; position: relative; } #code-hidden { position: absolute; height: 0; border: none; opacity: 0; } label[for="code-hidden"] { position: absolute; width: 100%; display: flex; justify-content: space-between; align-items: center; cursor: text; } .code-item { width: 40px; height: 40px; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; background-color: white; font-size: 1.2em; transition: background-color 0.2s ease; } .code-item.active { background-color: rgba(33, 216, 33, 0.5); } .code-item.focus { border-color: black; } #login { width: 90%; line-height: 40px; background-color: #13aa52; border: 1px solid #13aa52; border-radius: 4px; box-shadow: rgba(0, 0, 0, 0.1) 0 2px 4px 0; color: whitesmoke; cursor: pointer; text-align: center; transition: all 200ms; user-select: none; } #login:hover { box-shadow: rgba(0, 0, 0, .15) 0 3px 9px 0; transform: translateY(-2px); font-size: 1.05em; color: black; } </style> </head> <body> <div id="alert"> <div class="alert-title">提 示</div> <div class="alert-msg">提示信息——提示信息</div> <svg class="alert-close" viewBox="0 0 1024 1024"> <path d="M592.15872 511.9488L999.61856 26.25536c6.83008-8.06912 1.08544-20.33664-9.46176-20.33664H866.28352c-7.30112 0-14.2848 3.25632-19.08736 8.84736L511.1296 415.39584 175.07328 14.76608c-4.64896-5.59104-11.64288-8.84736-19.08736-8.84736H32.11264c-10.55744 0-16.29184 12.26752-9.46176 20.33664l407.45984 485.69344L22.64064 997.64224c-6.83008 8.06912-1.08544 20.33664 9.46176 20.33664h123.86304c7.30112 0 14.27456-3.25632 19.08736-8.8576l336.05632-400.62976 336.06656 400.62976c4.6592 5.59104 11.64288 8.8576 19.08736 8.8576h123.86304c10.5472 0 16.29184-12.26752 9.46176-20.33664L592.15872 511.9488z m0 0" /> </svg> </div> <div class="container"> <img class="wx-follow" src="/wx-follow" alt="wx-qr-code"> <div class="tip1">请先扫码关注【TinAI生态】微信公众号</div> <div class="choices"> <div id="by-scan" class="active">二维码</div> <div id="by-code">验证码</div> </div> <div id="scan-content"> <div class="tip2">请使用公众号的菜单功能扫描该登录二维码</div> <img id="scan-qrcode" src="/qrcode?ticket=asdfghjklzxcvbnmasdfghjklzxcvbnm" alt="login-qr-code"> </div> <div id="code-content"> <div class="tip2">请使用公众号的菜单功能获取登录验证码</div> <div class="code-box"> <input type="text" id="code-hidden"> <label for="code-hidden"> <div class="code-item"></div> <div class="code-item"></div> <div class="code-item"></div> <div class="code-item"></div> <div class="code-item"></div> <div class="code-item"></div> </label> </div> <div id="login">登&nbsp;&nbsp;&nbsp;&nbsp;录</div> </div> </div> <script> (() => { class Alert { #timer = null; #then = this.#default; #leave = false; #click = false; #$box = document.querySelector("#alert"); #$title = this.#$box.querySelector(".alert-title"); #$msg = this.#$box.querySelector(".alert-msg"); #$close = this.#$box.querySelector(".alert-close"); #default() { } #init() { if (this.#timer !== null) { clearTimeout(this.#timer); this.#timer = null; } this.#leave = false; this.#click = false; } #handleClose() { this.#init(); this.#$box.classList.remove("show"); this.#then(); } #common(msg, sec) { this.#init(); this.#$msg.textContent = msg; this.#timer = setTimeout(() => { this.#handleClose(); }, sec * 1000); } constructor() { this.#$close.addEventListener("click", () => { this.#click = true; this.#handleClose(); }); this.#$box.addEventListener("mouseenter", () => { this.#init(); }); this.#$box.addEventListener("mouseleave", () => { if (!this.#click) { this.#leave = true; setTimeout(() => { this.#leave && this.#handleClose(); }, 1000); } }); } info(msg, sec = 3) { this.#common(msg, sec); this.#$title.textContent = "提 示"; this.#$box.classList.remove("error"); this.#$box.classList.add("show"); return this; } warn(msg, sec = 3) { this.#common(msg, sec); this.#$title.textContent = "错 误"; this.#$box.classList.add("error", "show"); return this; } then(fn) { this.#then = fn || this.#default; } }; const alert = new Alert(); if (window.opener === null) { return setTimeout(() => { alert.warn("无效打开方式，3秒后自动关闭该标签页...").then(() => window.close()); }, 0); } const target = new URLSearchParams(window.location.search).get("target"); if (target === null) { return setTimeout(() => { alert.warn("回调地址不可为空，3秒后自动关闭该标签页...").then(() => window.close()); }, 0); } let success = false; const loginFailed = msg => { success = false; window.opener.postMessage(JSON.stringify({ code: 400, msg: msg }), target); alert.warn(msg); }; const loginSuccess = uid => { success = true; window.opener.postMessage(JSON.stringify({ code: 200, data: uid }), target); alert.info("登录成功，3秒后自动关闭该标签页...").then(() => window.close()); }; window.addEventListener("beforeunload", () => { success || loginFailed("用户取消登录"); }); /* 登录选项切换 */ (() => { const $byScan = document.querySelector("#by-scan"), $scanContent = document.querySelector("#scan-content"), $byCode = document.querySelector("#by-code"), $codeContent = document.querySelector("#code-content"); $byScan.addEventListener("click", () => { if ($byScan.classList.contains("active")) return; $byCode.classList.remove("active"); $codeContent.style.display = "none"; $byScan.classList.add("active"); $scanContent.style.display = "flex"; }); $byCode.addEventListener("click", () => { if ($byCode.classList.contains("active")) return; $byScan.classList.remove("active"); $scanContent.style.display = "none"; $byCode.classList.add("active"); $codeContent.style.display = "flex"; }); })(); /* 二维码 */ (() => { const $qrcode = document.querySelector("#scan-qrcode"); let ticket = null; fetch( "/oauth", { method: "POST", body: JSON.stringify({ type: "ticket" }) } ).then(res => res.json()).then(res => { if (res.code !== 200) { return alert.warn(res.msg); } ticket = res.data; $qrcode.setAttribute("src", "/qrcode?ticket=" + ticket); }).catch(e => { loginFailed("发生错误：" + e.message); }); let times = 0, timer = setInterval(() => { if (times++ > 100) { clearInterval(timer); loginFailed("登录超时"); return; } fetch( "/oauth", { method: "POST", body: JSON.stringify({ type: "query", data: ticket }) } ).then(res => res.json()).then(res => { if (res.code === 300) { console.log(res); } else if (res.code === 200) { loginSuccess(res.data); clearInterval(timer); } }).catch(e => { clearInterval(timer); loginFailed("发生错误：" + e.message); }); }, 3000); })(); /* 验证码 */ (() => { let index = 0, last = ""; const $input = document.querySelector("#code-hidden"), $boxs = document.querySelectorAll(".code-item"), $login = document.querySelector("#login"); $input.addEventListener("input", () => { const value = $input.value; if (!/^[0-9]{0,6}$/.test(value)) { return $input.value = last; } last = value; $boxs.forEach($box => { $box.textContent = ""; $box.classList.remove("active"); $box.classList.remove("focus"); }); for (let i = 0; i < value.length; i++) { $boxs[i].textContent = value[i]; $boxs[i].classList.add("active"); } index = value.length < 6 ? value.length : 5; $boxs[index].classList.add("focus"); }); $input.addEventListener("blur", function () { $boxs.forEach($box => { $box.classList.remove("focus"); }); }); $input.addEventListener("focus", () => { $boxs[index].classList.add("focus"); }); $login.addEventListener("click", () => { if (!/^[0-9]{6}$/.test(last)) { return alert.warn("请输入6位数字验证码"); } fetch( "/oauth", { method: "POST", body: JSON.stringify({ type: "login", data: last }) } ).then(res => res.json()).then(res => { if (res.code !== 200) { return alert.warn(res.msg); } loginSuccess(res.data); }).catch(e => { loginFailed(e.message); }); }); })(); })(); </script> </body> </html>
`;